name: Tests

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ stg, main ]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      BATCH_SIZE: ${{ vars.BATCH_SIZE }}
      LOG_LEVEL: ${{ vars.LOG_LEVEL }}
      STALE_METADATA_THRESHOLD: ${{ vars.STALE_METADATA_THRESHOLD }}
      REEL_DRIVER_THRESHOLD: ${{ vars.REEL_DRIVER_THRESHOLD }}
      TARGET_ACTIVE_ITEMS: ${{ vars.TARGET_ACTIVE_ITEMS }}
      TRANSFERRED_ITEM_CLEANUP_DELAY: ${{ vars.TRANSFERRED_ITEM_CLEANUP_DELAY }}
      HUNG_ITEM_CLEANUP_DELAY: ${{ vars.HUNG_ITEM_CLEANUP_DELAY }}

    steps:
    - uses: actions/checkout@v4

    - name: Debug environment variables
      run: |
        echo "STALE_METADATA_THRESHOLD: '$STALE_METADATA_THRESHOLD'"
        echo "BATCH_SIZE: '$BATCH_SIZE'"
        echo "LOG_LEVEL: '$LOG_LEVEL'"
        echo "REEL_DRIVER_THRESHOLD: '$REEL_DRIVER_THRESHOLD'"
        echo "All env vars:"
        env | grep -E "(STALE_|BATCH_|LOG_|REEL_|HUNG_|TARGET_|TRANSFERRED_)" | sort

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version-file: '.python-version'

    - name: Install uv
      run: pip install uv

    - name: Install dependencies
      run: uv pip install -r requirements.txt --system

    - name: Run utils tests
      run: pytest tests/unit/utils/ -v

    - name: Run core tests
      run: pytest tests/unit/core/ -v